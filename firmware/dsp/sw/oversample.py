import numpy as np
from matplotlib import pyplot as plt

bp_coeffs = [-0.0001820820367922369,0.0002901642306316145,-0.0003793550237843043,0.0004420593787840496,-0.00047020793116605436,0.000455793705625124,-0.0003919536353480232,0.00027450168708498946,-0.0001036949725617818,-0.00011408646717843329,0.0003651209962843791,-0.0006279580287626656,0.0008741609723834951,-0.001070345121168471,0.0011814914019655065,-0.0011753065337005257,0.0010271924730736336,-0.0007252150024302728,0.0002743533130128016,0.0003007063563998904,-0.0009548854992455179,0.0016246002798695675,-0.00223240474762177,0.002694231184876947,-0.0029287002866056296,0.002867626887325394,-0.002466569166218699,0.0017141045348023755,-0.000638497423362478,-0.0006894287553961518,0.002158091757825386,-0.00362204446165226,0.0049138272816396725,-0.005860041181517077,0.006300322793695275,-0.006107415047476873,0.00520619669530907,-0.003589414640281125,0.0013279861470509302,0.001425889467739128,-0.004443969554950115,0.00743593741630224,-0.010071595834038662,0.01200987487136967,-0.012932420841308896,0.012578886425898167,-0.010780654522770813,0.007489662229392393,-0.002799279891630324,-0.0030451543983325137,0.009647568627710976,-0.016474322234917276,0.02287796474001626,-0.02812850673272859,0.03144700636168664,-0.03203331499165839,0.029074674489240972,-0.0217106955407742,0.008901445913957227,0.010941207568837112,-0.0410095424779524,0.08972640236628933,-0.1888615277931052,0.6287715382203575,0.6287715382203575,-0.1888615277931052,0.08972640236628933,-0.0410095424779524,0.010941207568837112,0.008901445913957227,-0.0217106955407742,0.029074674489240972,-0.03203331499165839,0.03144700636168664,-0.02812850673272859,0.02287796474001626,-0.016474322234917276,0.009647568627710976,-0.0030451543983325137,-0.002799279891630324,0.007489662229392392,-0.010780654522770813,0.012578886425898167,-0.012932420841308896,0.012009874871369666,-0.01007159583403866,0.0074359374163022384,-0.004443969554950115,0.0014258894677391283,0.0013279861470509302,-0.003589414640281125,0.005206196695309069,-0.006107415047476871,0.006300322793695272,-0.0058600411815170755,0.004913827281639673,-0.00362204446165226,0.002158091757825386,-0.0006894287553961517,-0.0006384974233624779,0.0017141045348023748,-0.002466569166218698,0.0028676268873253944,-0.0029287002866056305,0.002694231184876947,-0.00223240474762177,0.0016246002798695675,-0.0009548854992455171,0.00030070635639989026,0.00027435331301280146,-0.0007252150024302728,0.0010271924730736336,-0.0011753065337005257,0.0011814914019655065,-0.001070345121168471,0.0008741609723834946,-0.0006279580287626652,0.00036512099628437935,-0.00011408646717843329,-0.0001036949725617818,0.00027450168708498946,-0.0003919536353480232,0.0004557937056251238,-0.00047020793116605436,0.0004420593787840496,-0.00037935502378430455,0.0002901642306316145,-0.0001820820367922369]

bp_coeffs_halfband = [0.0003897485594607689,0.00015693911456976745,-0.0003627967661677437,-0.0002904943988312347,0.0003089919066200533,0.000435899018262179,-0.00021199324379170593,-0.0005875738156037973,5.197580483449304e-05,0.0007265968366670756,0.00018763245514088006,-0.0008199618113990281,-0.0005123046476475712,0.0008235350488653096,0.000909052192800583,-0.0006887919029187548,-0.00134126575710242,0.00037268158444936177,0.001747308460805003,0.00015072529078900268,-0.002043942688347546,-0.0008786862836178526,0.002134963747508436,0.0017704840252818815,-0.0019245627848786537,-0.0027424594273696688,0.0013340761544895863,0.0036690592052564023,-0.0003200388277671059,-0.004390851651096396,-0.0011090242934829546,0.0047295169449401205,0.0028797631484937247,-0.004508778715695953,-0.004847536123777376,0.0035792688220842635,0.006798037889883712,-0.001844568480937239,-0.008457712447838352,-0.0007147092174272197,0.009512364661790184,0.0040218238877012405,-0.009631986317954472,-0.007892155552481045,0.008498396364900494,0.012029837569521508,-0.005830857826973916,-0.016031702611522067,0.0014031039473761588,0.01939405792564975,0.0049578003077852375,-0.021511493575344535,-0.013407699537386561,0.021642375630541742,0.024195664938863253,-0.018773219885394012,-0.03796451620661648,0.011156934683533874,0.056691758477619696,0.005484143109375296,-0.08778136705030748,-0.048529696821155745,0.18061801542345182,0.4131902155315222,0.4131902155315222,0.18061801542345182,-0.048529696821155745,-0.08778136705030748,0.005484143109375296,0.056691758477619696,0.011156934683533874,-0.03796451620661648,-0.018773219885394012,0.02419566493886325,0.021642375630541742,-0.013407699537386561,-0.021511493575344535,0.0049578003077852375,0.01939405792564975,0.0014031039473761588,-0.016031702611522064,-0.005830857826973916,0.012029837569521508,0.008498396364900494,-0.007892155552481041,-0.00963198631795447,0.00402182388770124,0.009512364661790184,-0.0007147092174272198,-0.008457712447838352,-0.001844568480937239,0.006798037889883711,0.003579268822084263,-0.004847536123777374,-0.004508778715695951,0.0028797631484937256,0.0047295169449401205,-0.0011090242934829546,-0.004390851651096395,-0.00032003882776710586,0.003669059205256401,0.0013340761544895858,-0.0027424594273696696,-0.0019245627848786544,0.0017704840252818815,0.002134963747508436,-0.0008786862836178526,-0.0020439426883475447,0.00015072529078900257,0.0017473084608050022,0.00037268158444936177,-0.00134126575710242,-0.0006887919029187548,0.000909052192800583,0.0008235350488653096,-0.0005123046476475709,-0.0008199618113990274,0.00018763245514088022,0.0007265968366670756,5.197580483449304e-05,-0.0005875738156037973,-0.00021199324379170593,0.0004358990182621788,0.0003089919066200533,-0.0002904943988312347,-0.0003627967661677439,0.00015693911456976745,0.0003897485594607689]

ncoeffs = len(bp_coeffs)
w = np.ones(ncoeffs)
w[0:ncoeffs//2] -= 0.6*np.arange(ncoeffs//2)       / ncoeffs
w[ncoeffs//2:]  -= 0.6*np.arange(ncoeffs//2)[::-1] / ncoeffs
B = np.fft.fft(bp_coeffs)
#plt.plot(np.abs(B))
#plt.plot(w)
#plt.show()
#exit()
B[0:ncoeffs//2] *= np.ones(ncoeffs//2) - 0.01*np.arange(ncoeffs//2)[::-1]
B[ncoeffs//2:]  *= np.ones(ncoeffs//2) - 0.01*np.arange(ncoeffs//2)
bp_coeffs_sloped = np.fft.ifft(B)



NFIR = 64
#s = np.sinc(np.linspace(-16,16,NFIR))
#w = np.hamming(NFIR)
#w = np.ones(NFIR)
#a = s*w
#a /= np.sum(a)

d = np.random.normal(size=512*1024)
f = np.convolve(d, bp_coeffs_sloped, mode='same')

t = np.arange(512*1024)*0
nt = 512*1024
#mixer = np.cos(t*np.pi/2.) + 1j*np.sin(t*np.pi/2.)
mixer = np.cos(t*np.pi/2.) + 1j*np.sin(t*np.pi/2.)
g = f*mixer


dr = d.reshape(512,1024)
fr = f.reshape(512,1024)
gr = g.reshape(512,1024)
grf = np.convolve(g, bp_coeffs_halfband, mode='same').reshape(512,1024)
grd = g[::2].reshape(512,512)
grfd = grf[::2].reshape(512,512)

D = np.abs(np.fft.fft(dr, axis=1))**2
F = np.abs(np.fft.fft(fr, axis=1))**2
G = np.abs(np.fft.fft(gr, axis=1))**2
GD = np.abs(np.fft.fft(grd, axis=1))**2
GFD = np.abs(np.fft.fft(grfd, axis=1))**2

Ds   = D.mean(axis=0)
Fs   = F.mean(axis=0)
Gs   = G.mean(axis=0)
GDs  = GD.mean(axis=0)
GFDs = GFD.mean(axis=0)

plot = plt.semilogy
shift = np.fft.fftshift

plt.figure()
frange = np.linspace(-1,1,Ds.shape[0])
franged = np.linspace(-0.5,0.5,GDs.shape[0])
plot(frange, Ds, label='nofilt')
plot(frange, Fs, label='filt')
plot(frange, Gs, label='filt-mix')
plot(frange[::2], GDs, label='filt-mix-dec')
plot(frange[::2], GFDs, label='filt-mix-filt-dec')
plt.legend()

plt.figure()
frange = np.linspace(-1,1,Ds.shape[0])
franged = np.linspace(-0.5,0.5,GDs.shape[0])
plot(frange, shift(Ds), label='nofilt')
plot(frange, shift(Fs), label='filt')
plot(frange, shift(Gs), label='filt-mix')
plot(frange[::2], shift(GDs), label='filt-mix-dec')
plot(frange[::2], shift(GFDs), label='filt-mix-filt-dec')
plt.legend()
#plt.xlim(0.4,0.6)

#plt.figure()
#plt.plot(bp_coeffs, '-o')

plt.show()
